"use strict";(self.webpackChunkTalkdeskChatSDK=self.webpackChunkTalkdeskChatSDK||[]).push([[119],{21879:function(t,e,n){n.d(e,{XN:function(){return defaultRegister},rP:function(){return defaultRegister}});var s=n(1883);defaultRegister.on=registerWithSpecificEmitter;var a=defaultRegister.handlers={},i=function globalRegister(t,e,n){registerWithSpecificEmitter(s.l_,i,t,e,n)}.handlers={};function defaultRegister(t,e,n,i){registerWithSpecificEmitter(i||s.EM,a,t,e,n)}function registerWithSpecificEmitter(t,e,n,a,i){if(i||(i="feature"),t||(t=s.EM),t.isBuffering(n)){var r=e[i]=e[i]||{};(r[n]=r[n]||[]).push([t,a])}else t.on(n,a)}},47916:function(t,e,n){n.d(e,{AG:function(){return nullable},FX:function(){return getAddStringContext},n1:function(){return addCustomAttributes},uR:function(){return numeric}});var s=n(30717),a=n(89247),i=n(98065),r=Object.prototype.hasOwnProperty,h=64;function nullable(t,e,n){return t||0===t||""===t?e(t)+(n?",":""):"!"}function numeric(t,e){return e?Math.floor(t).toString(36):void 0===t||0===t?"":Math.floor(t).toString(36)}function getAddStringContext(t){var e=Object.hasOwnProperty("create")?Object.create(null):{},n=0;return function addString(s){if(void 0===s||""===s)return"";var a=new i.R({agentIdentifier:t});s=String(s),a.shouldObfuscate()&&(s=a.obfuscateString(s));return r.call(e,s)?numeric(e[s],!0):(e[s]=n++,function quoteString(t){return"'"+t.replace(o,"\\$1")}(s))}}function addCustomAttributes(t,e){var n=[];return(0,s.D)(t,(function(t,s){if(!(n.length>=h)){var i,r=5;switch(t=e(t),typeof s){case"object":s?i=e((0,a.P)(s)):r=9;break;case"number":r=6,i=s%1?s:s+".";break;case"boolean":r=s?7:8;break;case"undefined":r=9;break;default:i=e(s)}n.push([r,t+(i?","+i:"")])}})),n}var o=/([,\\;])/g},82119:function(t,e,n){n.r(e),n.d(e,{Aggregate:function(){return Aggregate}});var s=n(21879),a=n(89247),i=n(47916),r=n(1883),h=n(80406),o=n(25768),u=n(46303),d=n(87024),l=n(40819),c=[];function domainMatchesPattern(t,e){return!(t.length>e.length)&&e.indexOf(t)===e.length-t.length}function comparePath(t,e){return 0===t.indexOf("/")&&(t=t.substring(1)),0===e.indexOf("/")&&(e=e.substring(1)),""===t||t===e}var g=n(83707);class Aggregate extends g.W{constructor(t,e){super(t,e),this.ajaxEvents=[],this.spaAjaxEvents={},this.sentAjaxEvents=[],this.scheduler,this.harvestTimeSeconds=(0,h.Mt)(this.agentIdentifier,"ajax.harvestTimeSeconds")||10,this.MAX_PAYLOAD_SIZE=(0,h.Mt)(this.agentIdentifier,"ajax.maxPayloadSize")||1e6,this.ee.on("interactionSaved",(function(t){this.spaAjaxEvents[t.id]&&delete this.spaAjaxEvents[t.id]})),this.ee.on("interactionDiscarded",(function(t){this.spaAjaxEvents[t.id]&&this.allAjaxIsEnabled()&&(this.spaAjaxEvents[t.id].forEach((function(t){this.ajaxEvents.push(t)})),delete this.spaAjaxEvents[t.id])})),this.allAjaxIsEnabled()&&function setDenyList(t){if(c=[],t&&t.length)for(var e=0;e<t.length;e++){var n=t[e];0===n.indexOf("http://")?n=n.substring(7):0===n.indexOf("https://")&&(n=n.substring(8));var s=n.indexOf("/");s>0?c.push({hostname:n.substring(0,s),pathname:n.substring(s)}):c.push({hostname:n,pathname:""})}}((0,h.Mt)(this.agentIdentifier,"ajax.deny_list")),(0,s.XN)("xhr",((...t)=>this.storeXhr(...t)),void 0,this.ee),this.allAjaxIsEnabled()&&(this.scheduler=new u.o("events",{onFinished:(...t)=>this.onEventsHarvestFinished(...t),getPayload:(...t)=>this.prepareHarvest(...t)}),this.scheduler.harvest.on("jserrors",(function(){return{body:this.aggregator.take(["xhr"])}})),this.scheduler.startTimer(this.harvestTimeSeconds),(0,d.l)(((...t)=>this.finalHarvest(...t))))}getStoredEvents(){return{ajaxEvents:this.ajaxEvents,spaAjaxEvents:this.spaAjaxEvents}}storeXhr(t,e,n,s,i){var h;if("localhost"!==t.hostname&&(e.time=n,h=t.cat?(0,a.P)([t.status,t.cat]):(0,a.P)([t.status,t.host,t.pathname]),(0,r.pr)("bstXhrAgg",["xhr",h,t,e],void 0,void 0,this.ee),this.aggregator.store("xhr",h,t,e),this.allAjaxIsEnabled()))if(function shouldCollectEvent(t){if(0===c.length)return!0;for(var e=0;e<c.length;e++){var n=c[e];if("*"===n.hostname)return!1;if(domainMatchesPattern(n.hostname,t.hostname)&&comparePath(n.pathname,t.pathname))return!1}return!0}(t)){var u=this,d={method:t.method,status:t.status,domain:t.host,path:t.pathname,requestSize:e.txSize,responseSize:e.rxSize,type:i,startTime:n,endTime:s,callbackDuration:e.cbTime};if(u.dt&&(d.spanId=u.dt.spanId,d.traceId=u.dt.traceId,d.spanTimestamp=u.dt.timestamp),this.spaNode){var g=this.spaNode.interaction.id;this.spaAjaxEvents[g]=this.spaAjaxEvents[g]||[],this.spaAjaxEvents[g].push(d)}else this.ajaxEvents.push(d)}else t.hostname===(0,o.C)(this.agentIdentifier).errorBeacon?(0,l.VB)("Ajax/Events/Excluded/Agent"):(0,l.VB)("Ajax/Events/Excluded/App")}prepareHarvest(t){if(t=t||{},0===this.ajaxEvents.length)return null;for(var e=this.getPayload(this.ajaxEvents,t.maxPayloadSize||this.MAX_PAYLOAD_SIZE),n=[],s=0;s<e.length;s++)n.push({body:{e:e[s]}});return t.retry&&(this.sentAjaxEvents=this.ajaxEvents.slice()),this.ajaxEvents=[],n}getPayload(t,e,n){n=n||1;for(var s=[],a=t.length/n,i=this.splitChunks(t,a),r=!1,h=0;h<i.length;h++){var o=i[h];if(o.tooBig(e)){if(1!==o.events.length){r=!0;break}}else s.push(o.payload)}return r?this.getPayload(t,e,++n):s}onEventsHarvestFinished(t){t.retry&&this.sentAjaxEvents.length>0&&this.allAjaxIsEnabled()&&(this.ajaxEvents=this.ajaxEvents.concat(this.sentAjaxEvents),this.sentAjaxEvents=[])}splitChunks(t,e){e=e||t.length;for(var n=[],s=0,a=t.length;s<a;s+=e)n.push(new this.Chunk(t.slice(s,s+e)));return n}Chunk(t){this.addString=(0,i.FX)(),this.events=t,this.payload="bel.7;";for(var e=0;e<this.events.length;e++){var n=this.events[e],s=[(0,i.uR)(n.startTime),(0,i.uR)(n.endTime-n.startTime),(0,i.uR)(0),(0,i.uR)(0),this.addString(n.method),(0,i.uR)(n.status),this.addString(n.domain),this.addString(n.path),(0,i.uR)(n.requestSize),(0,i.uR)(n.responseSize),"fetch"===n.type?1:"",this.addString(0),(0,i.AG)(n.spanId,this.addString,!0)+(0,i.AG)(n.traceId,this.addString,!0)+(0,i.AG)(n.spanTimestamp,i.uR,!1)],a="2,",r=(0,i.n1)((0,o.C)(this.agentIdentifier).jsAttributes||{},this.addString);s.unshift((0,i.uR)(r.length)),a+=s.join(","),r&&r.length>0&&(a+=";"+r.join(";")),e+1<this.events.length&&(a+=";"),this.payload+=a}this.tooBig=function(t){return t=t||this.MAX_PAYLOAD_SIZE,2*this.payload.length>t}}allAjaxIsEnabled(){return!1!==(0,h.Mt)(this.agentIdentifier,"ajax.enabled")}}}}]);
//# sourceMappingURL=119.talkdeskchatsdk.js.map