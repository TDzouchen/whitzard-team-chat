"use strict";(self.webpackChunkTalkdeskChatSDK=self.webpackChunkTalkdeskChatSDK||[]).push([[706],{35187:function(e,t,r){r.d(t,{I:function(){return n}});var n=0,a=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);a&&(n=+a[1])},41374:function(e,t,r){r.d(t,{e:function(){return parseUrl}});var n={};function parseUrl(e){if(e in n)return n[e];var t=document.createElement("a"),r=window.location,a={};t.href=e,a.port=t.port;var i=t.href.split("://");!a.port&&i[1]&&(a.port=i[1].split("/")[0].split("@").pop().split(":")[1]),a.port&&"0"!==a.port||(a.port="https"===i[0]?"443":"80"),a.hostname=t.hostname||r.hostname,a.pathname=t.pathname,a.protocol=i[0],"/"!==a.pathname.charAt(0)&&(a.pathname="/"+a.pathname);var o=!t.protocol||":"===t.protocol||t.protocol===r.protocol,s=t.hostname===document.domain&&t.port===r.port;return a.sameOrigin=o&&(!t.hostname||s),"/"===a.pathname&&(n[e]=a),a}},94706:function(e,t,r){r.r(t),r.d(t,{Instrument:function(){return Instrument},getWrappedFetch:function(){return getWrappedFetch}});var n=r(51474),a=r(11249),i=r(70309),o=r(1883),s=r(92055),d=r(22391),h=1,c="nr@id";function id(e){var t=typeof e;return!e||"object"!==t&&"function"!==t?-1:e===window?0:(0,d.X)(e,c,(function(){return h++}))}var l=r(35187);function dataSize(e){if("string"==typeof e&&e.length)return e.length;if("object"==typeof e){if("undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&e.byteLength)return e.byteLength;if("undefined"!=typeof Blob&&e instanceof Blob&&e.size)return e.size;if(!("undefined"!=typeof FormData&&e instanceof FormData))try{return JSON.stringify(e).length}catch(e){return}}}var u=r(74137),p=r(41437),f=r(27531),m=r(41374),g=r(80406),v=r(69581);class DT{constructor(e){this.agentIdentifier=e}generateTracePayload(e){if(!this.shouldGenerateTrace(e))return null;var t=(0,i.D)(this.agentIdentifier);if(!t)return null;var r=(t.accountID||"").toString()||null,n=(t.agentID||"").toString()||null,a=(t.trustKey||"").toString()||null;if(!r||!n)return null;var o=(0,v.M)(),s=(0,v.Ht)(),d=Date.now(),h={spanId:o,traceId:s,timestamp:d};return(e.sameOrigin||this.isAllowedOrigin(e)&&this.useTraceContextHeadersForCors())&&(h.traceContextParentHeader=this.generateTraceContextParentHeader(o,s),h.traceContextStateHeader=this.generateTraceContextStateHeader(o,d,r,n,a)),(e.sameOrigin&&!this.excludeNewrelicHeader()||!e.sameOrigin&&this.isAllowedOrigin(e)&&this.useNewrelicHeaderForCors())&&(h.newrelicHeader=this.generateTraceHeader(o,s,d,r,n,a)),h}generateTraceContextParentHeader(e,t){return"00-"+t+"-"+e+"-01"}generateTraceContextStateHeader(e,t,r,n,a){return a+"@nr=0-1-"+r+"-"+n+"-"+e+"----"+t}generateTraceHeader(e,t,r,n,a,i){if(!("btoa"in window&&"function"==typeof window.btoa))return null;var o={v:[0,1],d:{ty:"Browser",ac:n,ap:a,id:e,tr:t,ti:r}};return i&&n!==i&&(o.d.tk=i),btoa(JSON.stringify(o))}shouldGenerateTrace(e){return this.isDtEnabled()&&this.isAllowedOrigin(e)}isAllowedOrigin(e){var t=!1,r={};if((0,g.Mt)("distributed_tracing")&&(r=(0,g.P_)().distributed_tracing),e.sameOrigin)t=!0;else if(r.allowed_origins instanceof Array)for(var n=0;n<r.allowed_origins.length;n++){var a=(0,m.e)(r.allowed_origins[n]);if(e.hostname===a.hostname&&e.protocol===a.protocol&&e.port===a.port){t=!0;break}}return t}isDtEnabled(){var e=(0,g.Mt)(this.agentIdentifier,"distributed_tracing");return!!e&&!!e.enabled}excludeNewrelicHeader(){var e=(0,g.Mt)(this.agentIdentifier,"distributed_tracing");return!!e&&!!e.exclude_newrelic_header}useNewrelicHeaderForCors(){var e=(0,g.Mt)(this.agentIdentifier,"distributed_tracing");return!!e&&!1!==e.cors_use_newrelic_header}useTraceContextHeadersForCors(){var e=(0,g.Mt)(this.agentIdentifier,"distributed_tracing");return!!e&&!e.cors_use_tracecontext_headers}}var x=r(83707),b=["load","error","abort","timeout"],w=b.length,S=n.Y.REQ,C=window.XMLHttpRequest;class Instrument extends x.W{constructor(e){super(e),(0,a.O)(this.agentIdentifier).xhrWrappable&&!(0,a.O)(this.agentIdentifier).disabled&&(this.dt=new DT(this.agentIdentifier))}}function getWrappedFetch(){var e=(0,f.u5)(s.ee);return function subscribeToEvents(e,t){function onNewXhr(e){var t=this;t.totalCbs=0,t.called=0,t.cbTime=0,t.end=end,t.ended=!1,t.xhrGuids={},t.lastSize=null,t.loadCaptureCalled=!1,t.params=this.params||{},t.metrics=this.metrics||{},e.addEventListener("load",(function(r){captureXhrData(t,e)}),(0,u.m)(!1)),l.I&&(l.I>34||l.I<10)||e.addEventListener("progress",(function(e){t.lastSize=e.loaded}),(0,u.m)(!1))}function onOpenXhrStart(e){this.params={method:e[0]},addUrl(this,e[1]),this.metrics={}}function onOpenXhrEnd(e,t){var r=(0,i.D)();"xpid"in r&&this.sameOrigin&&t.setRequestHeader("X-NewRelic-ID",r.xpid);var n=this.dt.generateTracePayload(this.parsedOrigin);if(n){var a=!1;n.newrelicHeader&&(t.setRequestHeader("newrelic",n.newrelicHeader),a=!0),n.traceContextParentHeader&&(t.setRequestHeader("traceparent",n.traceContextParentHeader),n.traceContextStateHeader&&t.setRequestHeader("tracestate",n.traceContextStateHeader),a=!0),a&&(this.dt=n)}}function onSendXhrStart(t,r){var n=this.metrics,a=t[0],i=this;if(n&&a){var o=dataSize(a);o&&(n.txSize=o)}this.startTime=(0,p.zO)(),this.listener=function(t){try{"abort"!==t.type||i.loadCaptureCalled||(i.params.aborted=!0),("load"!==t.type||i.called===i.totalCbs&&(i.onloadCalled||"function"!=typeof r.onload))&&i.end(r)}catch(t){try{e.emit("internal-error",[t])}catch(e){}}};for(var s=0;s<w;s++)r.addEventListener(b[s],this.listener,(0,u.m)(!1))}function onXhrCbTime(e,t,r){this.cbTime+=e,t?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof r.onload||this.end(r)}function onXhrLoadAdded(e,t){var r=""+id(e)+!!t;this.xhrGuids&&!this.xhrGuids[r]&&(this.xhrGuids[r]=!0,this.totalCbs+=1)}function onXhrLoadRemoved(e,t){var r=""+id(e)+!!t;this.xhrGuids&&this.xhrGuids[r]&&(delete this.xhrGuids[r],this.totalCbs-=1)}function onXhrResolved(){this.endTime=(0,p.zO)()}function onAddEventListenerEnd(t,r){r instanceof C&&"load"===t[0]&&e.emit("xhr-load-added",[t[1],t[2]],r)}function onRemoveEventListenerEnd(t,r){r instanceof C&&"load"===t[0]&&e.emit("xhr-load-removed",[t[1],t[2]],r)}function onFnStart(e,t,r){t instanceof C&&("onload"===r&&(this.onload=!0),("load"===(e[0]&&e[0].type)||this.onload)&&(this.xhrCbStart=(0,p.zO)()))}function onFnEnd(t,r){this.xhrCbStart&&e.emit("xhr-cb-time",[(0,p.zO)()-this.xhrCbStart,this.onload,r],r)}function onFetchBeforeStart(e){var t,r=e[1]||{};"string"==typeof e[0]?t=e[0]:e[0]&&e[0].url?t=e[0].url:window.URL&&e[0]&&e[0]instanceof URL&&(t=e[0].href),t&&(this.parsedOrigin=(0,m.e)(t),this.sameOrigin=this.parsedOrigin.sameOrigin);var n=this.dt.generateTracePayload(this.parsedOrigin);if(n&&(n.newrelicHeader||n.traceContextParentHeader))if("string"==typeof e[0]||window.URL&&e[0]&&e[0]instanceof URL){var a={};for(var i in r)a[i]=r[i];a.headers=new Headers(r.headers||{}),addHeaders(a.headers,n)&&(this.dt=n),e.length>1?e[1]=a:e.push(a)}else e[0]&&e[0].headers&&addHeaders(e[0].headers,n)&&(this.dt=n);function addHeaders(e,t){var r=!1;return t.newrelicHeader&&(e.set("newrelic",t.newrelicHeader),r=!0),t.traceContextParentHeader&&(e.set("traceparent",t.traceContextParentHeader),t.traceContextStateHeader&&e.set("tracestate",t.traceContextStateHeader),r=!0),r}}function onFetchStart(e,t){this.params={},this.metrics={},this.startTime=(0,p.zO)(),this.dt=t,e.length>=1&&(this.target=e[0]),e.length>=2&&(this.opts=e[1]);var r,n=this.opts||{},a=this.target;"string"==typeof a?r=a:"object"==typeof a&&a instanceof S?r=a.url:window.URL&&"object"==typeof a&&a instanceof URL&&(r=a.href),addUrl(this,r);var i=(""+(a&&a instanceof S&&a.method||n.method||"GET")).toUpperCase();this.params.method=i,this.txSize=dataSize(n.body)||0}function onFetchDone(e,r){var n;this.endTime=(0,p.zO)(),this.params||(this.params={}),this.params.status=r?r.status:0,"string"==typeof this.rxSize&&this.rxSize.length>0&&(n=+this.rxSize);var a={txSize:this.txSize,rxSize:n,duration:(0,p.zO)()-this.startTime};t("xhr",[this.params,a,this.startTime,this.endTime,"fetch"],this)}function end(e){var r=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var a=0;a<w;a++)e.removeEventListener(b[a],this.listener,!1);r.aborted||(n.duration=(0,p.zO)()-this.startTime,this.loadCaptureCalled||4!==e.readyState?null==r.status&&(r.status=0):captureXhrData(this,e),n.cbTime=this.cbTime,t("xhr",[r,n,this.startTime,this.endTime,"xhr"],this))}}function addUrl(e,t){var r=(0,m.e)(t),n=e.params;n.hostname=r.hostname,n.port=r.port,n.protocol=r.protocol,n.host=r.hostname+":"+r.port,n.pathname=r.pathname,e.parsedOrigin=r,e.sameOrigin=r.sameOrigin}function captureXhrData(e,t){e.params.status=t.status;var r=function responseSizeFromXhr(e,t){var r=e.responseType;return"json"===r&&null!==t?t:"arraybuffer"===r||"blob"===r||"json"===r?dataSize(e.response):"text"===r||""===r||void 0===r?dataSize(e.responseText):void 0}(t,e.lastSize);if(r&&(e.metrics.rxSize=r),e.sameOrigin){var n=t.getResponseHeader("X-NewRelic-App-Data");n&&(e.params.cat=n.split(", ").pop())}e.loadCaptureCalled=!0}e.on("new-xhr",onNewXhr),e.on("open-xhr-start",onOpenXhrStart),e.on("open-xhr-end",onOpenXhrEnd),e.on("send-xhr-start",onSendXhrStart),e.on("xhr-cb-time",onXhrCbTime),e.on("xhr-load-added",onXhrLoadAdded),e.on("xhr-load-removed",onXhrLoadRemoved),e.on("xhr-resolved",onXhrResolved),e.on("addEventListener-end",onAddEventListenerEnd),e.on("removeEventListener-end",onRemoveEventListenerEnd),e.on("fn-end",onFnEnd),e.on("fetch-before-start",onFetchBeforeStart),e.on("fetch-start",onFetchStart),e.on("fn-start",onFnStart),e.on("fetch-done",onFetchDone)}(s.ee,o.pr),e}}}]);
//# sourceMappingURL=706.talkdeskchatsdk.js.map